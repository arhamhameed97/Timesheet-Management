// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Seed script configuration
// Run with: npx tsx prisma/seed.ts

enum UserRole {
  SUPER_ADMIN
  COMPANY_ADMIN
  MANAGER
  TEAM_LEAD
  EMPLOYEE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LATE
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum PayrollStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum TeamMemberRole {
  LEAD
  MEMBER
}

enum PaymentType {
  HOURLY
  SALARY
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  APPROVED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum LeaveDuration {
  FULL_DAY
  HALF_DAY_MORNING
  HALF_DAY_AFTERNOON
}

enum PayrollEditRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TaskType {
  GENERAL
  PAYROLL_EDIT
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Company {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  designations Designation[]
  teams        Team[]
}

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  password      String
  name          String
  companyId     String?
  designationId String?
  role          UserRole     @default(EMPLOYEE)
  managerId     String? // For hierarchy - who manages this user
  phone         String?
  paymentType   PaymentType?
  hourlyRate    Float?
  monthlySalary Float?
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  company      Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  designation  Designation? @relation(fields: [designationId], references: [id], onDelete: SetNull)
  manager      User?        @relation("UserHierarchy", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates User[]       @relation("UserHierarchy")

  attendance         Attendance[]
  timesheets         Timesheet[]
  approvedTimesheets Timesheet[]    @relation("TimesheetApprover")
  taskLogs           TaskLog[]
  teams              TeamMember[]
  teamProgress       TeamProgress[]
  payroll            Payroll[]
  leaves             Leave[]
  managedTeams       Team[]         @relation("TeamManager")
  assignedTasks      TaskAssignee[]
  createdTasks       Task[]         @relation("TaskCreator")
  approvedTasks      Task[]         @relation("TaskApprover")
  hourlyRatePeriods  HourlyRatePeriod[]
  overtimeConfigs    OvertimeConfig[]
  payrollEditRequestsRequested PayrollEditRequest[] @relation("PayrollEditRequestRequester")
  payrollEditRequestsAssigned  PayrollEditRequest[] @relation("PayrollEditRequestAssignee")
  payrollEditRequestsApproved PayrollEditRequest[] @relation("PayrollEditRequestApprover")
  createdHourlyRatePeriods HourlyRatePeriod[] @relation("HourlyRatePeriodCreator")
  createdOvertimeConfigs   OvertimeConfig[] @relation("OvertimeConfigCreator")
  dailyPayrollOverrides DailyPayrollOverride[]
  createdDailyPayrollOverrides DailyPayrollOverride[] @relation("DailyPayrollOverrideCreator")
  reviewedCompanyRegistrations CompanyRegistrationRequest[] @relation("CompanyRegistrationReviewer")
}

model Designation {
  id        String   @id @default(cuid())
  name      String
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users   User[]
}

model Attendance {
  id           String           @id @default(cuid())
  userId       String
  date         DateTime         @db.Date
  checkInTime  DateTime?
  checkOutTime DateTime?
  status       AttendanceStatus @default(PRESENT)
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model Timesheet {
  id         String          @id @default(cuid())
  userId     String
  date       DateTime        @db.Date
  hours      Float
  status     TimesheetStatus @default(DRAFT)
  approvedBy String?
  approvedAt DateTime?
  notes      String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskLogs TaskLog[]
  approver User?     @relation("TimesheetApprover", fields: [approvedBy], references: [id], onDelete: SetNull)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([status])
}

model TaskLog {
  id          String   @id @default(cuid())
  timesheetId String
  userId      String
  description String
  hours       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  timesheet Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([timesheetId])
  @@index([userId])
}

model Team {
  id          String   @id @default(cuid())
  name        String
  companyId   String
  managerId   String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company  Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager  User?          @relation("TeamManager", fields: [managerId], references: [id], onDelete: SetNull)
  members  TeamMember[]
  progress TeamProgress[]

  @@index([companyId])
}

model TeamMember {
  id       String         @id @default(cuid())
  teamId   String
  userId   String
  role     TeamMemberRole @default(MEMBER)
  joinedAt DateTime       @default(now())
  leftAt   DateTime?

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamProgress {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  update    String
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([userId])
  @@index([date])
}

model Payroll {
  id              String        @id @default(cuid())
  userId          String
  month           Int
  year            Int
  paymentType     PaymentType?
  hoursWorked     Float?
  hourlyRate      Float?
  baseSalary      Float
  bonuses         Json? // Array of { name: string, amount: number }
  deductions      Json? // Array of { name: string, amount: number }
  totalBonuses    Float         @default(0)
  totalDeductions Float         @default(0)
  netSalary       Float
  status          PayrollStatus @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  paidAt          DateTime?
  notes           String?
  overtimeHours   Float?
  overtimePay     Float?
  regularHours    Float?
  dailyHours      Json? // Array of { date: string, hours: number, overtimeHours: number }
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  editRequests    PayrollEditRequest[]
  relatedTasks    Task[]

  @@unique([userId, month, year])
  @@index([userId, month, year])
  @@index([status])
}

model Leave {
  id            String        @id @default(cuid())
  userId        String
  startDate     DateTime      @db.Date
  endDate       DateTime      @db.Date
  type          String // e.g., "Sick Leave", "Vacation", "Personal"
  reason        String?
  status        LeaveStatus   @default(PENDING)
  leaveDuration LeaveDuration @default(FULL_DAY)
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([startDate, endDate])
}

model Task {
  id                        String       @id @default(cuid())
  title                     String
  description               String?
  assignedBy                String
  dueDate                   DateTime
  priority                  TaskPriority @default(MEDIUM)
  status                    TaskStatus   @default(PENDING)
  approvedBy                String?
  approvedAt                DateTime?
  type                      TaskType     @default(GENERAL)
  relatedPayrollId          String?
  relatedPayrollEditRequestId String?     @unique
  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @updatedAt

  creator                   User           @relation("TaskCreator", fields: [assignedBy], references: [id], onDelete: Cascade)
  approver                  User?          @relation("TaskApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  assignees                 TaskAssignee[]
  relatedPayroll            Payroll?       @relation(fields: [relatedPayrollId], references: [id], onDelete: SetNull)
  relatedPayrollEditRequest PayrollEditRequest? @relation(fields: [relatedPayrollEditRequestId], references: [id], onDelete: SetNull)

  @@index([assignedBy])
  @@index([status])
  @@index([dueDate])
  @@index([type])
  @@index([relatedPayrollId])
  @@index([relatedPayrollEditRequestId])
}

model TaskAssignee {
  id          String    @id @default(cuid())
  taskId      String
  userId      String
  assignedAt  DateTime  @default(now())
  completedAt DateTime?

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model HourlyRatePeriod {
  id          String   @id @default(cuid())
  userId      String
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  hourlyRate  Float
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator   User   @relation("HourlyRatePeriodCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDate])
  @@index([endDate])
}

model OvertimeConfig {
  id                  String   @id @default(cuid())
  userId              String   @unique
  weeklyThresholdHours Float   @default(40)
  overtimeMultiplier  Float   @default(1.5)
  createdBy           String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator User @relation("OvertimeConfigCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PayrollEditRequest {
  id            String                 @id @default(cuid())
  payrollId     String
  requestedBy   String
  assignedTo    String
  status        PayrollEditRequestStatus @default(PENDING)
  changes       Json // Object with changed fields
  originalData  Json // Original payroll data before changes
  requestedAt   DateTime                @default(now())
  approvedAt   DateTime?
  approvedBy   String?
  notes         String?

  payroll    Payroll @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  requester  User    @relation("PayrollEditRequestRequester", fields: [requestedBy], references: [id], onDelete: Cascade)
  assignee   User    @relation("PayrollEditRequestAssignee", fields: [assignedTo], references: [id], onDelete: Cascade)
  approver   User?   @relation("PayrollEditRequestApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  task       Task?

  @@index([payrollId])
  @@index([requestedBy])
  @@index([assignedTo])
  @@index([status])
}

model DailyPayrollOverride {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @db.Date
  hourlyRate    Float?   // Override hourly rate for this day
  regularHours  Float?   // Override regular hours
  overtimeHours Float?   // Override overtime hours
  totalHours    Float?   // Calculated: regularHours + overtimeHours
  earnings      Float?   // Calculated earnings (can be manually set)
  notes         String?
  createdBy     String   // Admin/manager who made the edit
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator User @relation("DailyPayrollOverrideCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
}

model CompanyRegistrationRequest {
  id            String             @id @default(cuid())
  companyName   String
  companyEmail  String
  companyAddress String?
  adminName     String
  adminEmail    String
  adminPassword String // Will be hashed before creating user
  status        RegistrationStatus @default(PENDING)
  submittedAt   DateTime           @default(now())
  reviewedBy    String?
  reviewedAt    DateTime?
  notes         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  reviewer User? @relation("CompanyRegistrationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([submittedAt])
  @@index([companyEmail])
  @@index([adminEmail])
}
